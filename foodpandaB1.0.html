<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>報酬計算</title>
<style>
/* === 整體暗黑模式 === */
body {
  font-family: Arial, sans-serif;
  margin: 40px;
  background: #121212;
  color: #eee;
}
/*
.container {
  max-width: 500px;
  margin: auto;
  background: #1e1e1e;
  padding: 20px;
  border-radius: 22px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}
*/
.container {
  width: 90%;
  max-width: 500px;
  margin: auto;
  background: #1e1e1e;
  padding: 20px;
  border-radius: 22px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  box-sizing: border-box;
}
h2 {
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #eee;
}
label { display: block; margin-top: 10px; font-weight: bold; color: #eee; }
.input-group { display: flex; margin: 10px 0; }
input { width: calc(100% - 50px); padding: 10px; font-size: 16px; background: #2a2a2a; color: #eee; border: 1px solid #555; border-radius: 6px; }

/* 統一 +、-、重置樣式 */
.inc-btn, .dec-btn, .reset-btn {
  width: 60px;
  height: 60px;
  font-size: 26px;
  margin-left: 5px;
  border: none;
  border-radius: 8px;
  background: #ff69b4;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s, background 0.2s;
}
.inc-btn:hover, .dec-btn:hover, .reset-btn:hover {
  background: #005fa3;
  transform: rotate(20deg);
}

.result { margin-top: 15px; font-size: 28px; text-align: center; font-weight: bold; }
#amount { width: 200px; font-size: 28px; text-align: center; background: #2a2a2a; border: 1px solid #555; color: #fc1212; }

#formula { margin-top: 15px; font-size: 16px; color: #eee; line-height: 1.5; white-space: pre-line; text-align: center; }
#oldFormula, #secondHint {
  margin-top: 2px;
  font-size: 15px;
  color: #ccc;
  line-height: 1.4;
  white-space: normal;
  text-align: center;
}
#errorMsg { color:red; margin-bottom:10px; font-weight:bold; }

/* ✅ 單獨控制疊單那排大小，不影響上方主金額 */
.sub-result {
  font-size: 16px !important;   /* 疊單與元變小 */
}

.sub-result #secondAmount {
  width: 70px !important;
  font-size: 18px !important;
  padding: 2px 4px !important;
}

body, button {
  touch-action: manipulation;
  -webkit-user-select: none;
  -webkit-tap-highlight-color: transparent;
}

input {
  touch-action: auto;
  -webkit-user-select: text;
}

/* 隱藏數字輸入框的上下箭頭 */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
input[type=number] { -moz-appearance: textfield; }

/* 取消按鈕按下動畫 */
button, .calc-btn, .reset-btn { transition: none !重要; transform: none !important; }
button:active, .calc-btn:active, .reset-btn:active { transform: none !important; scale: 1 !important; }

/* 取單率區塊背景暗黑化 */
.order-block { max-width:300px; margin:20px auto; font-size:16px; font-family:Arial, sans-serif; color:#eee; }
.order-block input { background:#2a2a2a; color:#eee; border:1px solid #555; }
.order-block span { color:#ccc; }
.order-block button { background:#0078d7; color:#fff; }

#base25 {
  font-size: 15px;
  color: #ccc;
  margin-top: 4px;
  text-align: center;
}

#extraFee {
  font-size: 15px;
  color: #ccc;
  margin-top: 4px;
  text-align: center;
}

#base25secondHint {
  font-size: 15px;
  color: #ccc;
  margin-top: 4px;
  text-align: center;
}

#extraFeesecondHint {
  font-size: 15px;
  color: #ccc;
  margin-top: 4px;
  text-align: center;
}

/* 小螢幕 */
@media (max-width: 375px) {
  .inc-btn, .dec-btn, .reset-btn {
    width: 50px;
    height: 50px;
    font-size: 20px;
  }
  #amount {
    font-size: 32px;
    width: 150px;
  }
  #formula, #oldFormula, #secondHint {
    font-size: 14px;
  }
}
</style>
</head>

<body>
<div class="container">
  <h2>
    報酬計算
    <button class="reset-btn" onclick="resetValues()">🔄</button>
  </h2>

  <label>當時倍率：</label>
  <div class="input-group">
    <input type="number" id="yVal" value="1.40" step="0.10" oninput="calc()">
    <button class="inc-btn" onclick="change('yVal', 0.10)">+</button>
    <button class="dec-btn" onclick="change('yVal', -0.10)">-</button>
  </div>
  
  <label>總公里數：</label>
  <div class="input-group">
    <input type="number" id="xVal" value="2.50" step="0.10" oninput="calc()">
    <button class="inc-btn" onclick="change('xVal', 0.10)">+</button>
    <button class="dec-btn" onclick="change('xVal', -0.10)">-</button>
  </div>

<!-- 🚀 改版：隱藏公里加成輸入框，但保留代碼 -->
<!--
<label>公里加成：</label>
<div class="input-group">
  <input type="number" id="kmFee" value="11.50" step="0.10" oninput="calc()">
</div>
-->

  <div id="errorMsg"></div>

  <div class="result">
    <input type="number" id="amount" value="" step="0.01" placeholder="輸入金額" /> 元
    <div id="base25"></div>
    <div id="extraFee"></div>
    <div id="secondHint"></div>
    <div class="sub-result">
      <span class="second-text">疊單：</span>
      <input type="number" id="secondAmount" value="" step="0.01" 
        style="width:90px; font-size:18px; text-align:center; background:#2a2a2a; color:#eee; border:1px solid #555; border-radius:6px;"> 元
    </div>
    <div id="base25secondHint"></div>
    <div id="extraFeesecondHint"></div>
    <div id="oldFormula"></div>
  </div>
</div>

<script>
// const kmFeeInput = document.getElementById('kmFee'); // ← 不再抓取輸入框
const DEFAULT_X = 2.50;   // 預設公里數
const DEFAULT_Y = 1.40;   // 預設倍率
const SECOND_FLOOR = 30;  // 疊單最低價
let KM_FEE = 12.142;      // 🧭 全域公里加成，可自由調整測試

function change(id, delta) {
  const input = document.getElementById(id);
  let value = parseFloat(input.value) || 0;

  // 限制公里數最低為 2.50
  if (id === "xVal") {
    value += delta;
    if (value < 2.50) value = 2.50;
  } else {
    value += delta;
    if (value < 0) value = 0;
  }

  input.value = value.toFixed(2);
  calc();
}

function showError(msg) {
  document.getElementById('errorMsg').innerText = msg || '';
}

function calc() {
  const x = parseFloat(document.getElementById('xVal').value);
  const y = parseFloat(document.getElementById('yVal').value);
  const amountInput = document.getElementById('amount');

  if (isNaN(x) || isNaN(y)) { showError(''); return; } else { showError(''); }

  // === 新算法 ===
  const baseFirst = (10 + 10 + 5 + 5) * y;                    // 第一單固定部分
  const distancePart = Math.max(0, (x - 2.50)) * KM_FEE * y;  // 距離加成（兩者共用）

  // 第一單
  const first = baseFirst + distancePart;

  // ▶ 疊單（2.5 公里內：「max(30, 20*y)」，超過距離再加距離費）
  const baseSecondRaw = (10 + 5 + 5) * y;                     // 20 * y
  const baseSecond25 = Math.max(SECOND_FLOOR, baseSecondRaw); // 低於30時顯示30，否則顯示 20*y
  const distanceSecondFee = distancePart;                     // 疊單距離加成同上
  const second = baseSecond25 + distanceSecondFee;            // (max(30,20y)) + 距離加成

  // 顯示第一單金額（若不是在手動改第一單金額）
  if (!(document.activeElement && document.activeElement.id === 'amount')) {
    amountInput.value = first.toFixed(2);
  }

  // 文字顯示
  const base25 = (10 + 10 + 5 + 5) * y;                       // 2.5 公里內第一單金額
  const distanceFee = distancePart;                           // 多出里程費用
  document.getElementById('base25').innerText = `目前單價： ${base25.toFixed(2)} 元`;
  document.getElementById('extraFee').innerText = `多出里程費用： ${distanceFee.toFixed(2)} 元`;

  // 疊單金額更新輸入框（若不是在手動改疊單金額）
  const secondInput = document.getElementById('secondAmount');
  const activeId = document.activeElement ? document.activeElement.id : "";
  if (activeId !== 'secondAmount') {
    secondInput.value = second.toFixed(2);
  }
  document.getElementById('base25secondHint').innerText = `目前疊單單價： ${baseSecond25.toFixed(2)} 元`;
  document.getElementById('extraFeesecondHint').innerText = `多出疊單里程費用： ${distanceSecondFee.toFixed(2)} 元`;

  // 舊制參考
  const oldResultRush = (40 + ((x - 2.5) * 15) + 2).toFixed(2);
  const diffRush = (first - oldResultRush).toFixed(2);
  document.getElementById('oldFormula').innerHTML =
    `舊制算法：餐期 40+2 + ${(x - 2.5).toFixed(2)}×15 = <span style="color:#fa6969; font-weight:bold;">${oldResultRush} 元</span><br>(差 ${diffRush} 元)`;
}

document.getElementById('amount').addEventListener('input', function() {
  const price = parseFloat(this.value);
  const y = parseFloat(document.getElementById('yVal').value);
  const xInput = document.getElementById('xVal');

  if (this.value === '') { showError(''); return; }
  if (isNaN(price) || isNaN(y) || y === 0) { showError(''); return; }

  // 金額反推公里數（第一單公式）
  const fixedPart = (10 + 10 + 5 + 5) * y;
  const x = ((price - fixedPart) / (KM_FEE * y)) + 2.5;

  if (!isFinite(x)) return;
  if (x < 2.50) return;

  xInput.value = x.toFixed(2);
  calc();
});

// 疊單金額反推公里數
document.getElementById('secondAmount').addEventListener('input', function() {
  const price = parseFloat(this.value);
  const y = parseFloat(document.getElementById('yVal').value);
  const xInput = document.getElementById('xVal');
  const base = Math.max(30, (10 + 5 + 5) * y); // = max(30, 20*y)

  if (this.value === '' || isNaN(price) || isNaN(y) || y === 0) return;

  // 疊單反推公里數公式
  const x = ((price - base) / (KM_FEE * y)) + 2.5;
  if (!isFinite(x) || x < 2.5) return;

  xInput.value = x.toFixed(2);
  calc();
});

function resetValues() {
  document.getElementById('xVal').value = DEFAULT_X.toFixed(2);
  document.getElementById('yVal').value = DEFAULT_Y.toFixed(2);
  calc();
}

window.onload = function() { resetValues(); };
</script>

<!-- === 過往記錄區塊（黑暗化） === -->
<div class="order-block" style="background:#1e1e1e; padding:10px; border-radius:12px;">
  <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #555; padding:8px 0;">
    <label for="completed" style="font-size:14px; color:#eee;">過往記錄完成訂單件數</label>
    <input type="number" id="completed" value=""
           style="width:60px; text-align:right; font-size:14px; background:#2a2a2a; color:#eee; border:1px solid #555; border-radius:6px; padding:4px 6px;">
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #555; padding:8px 0;">
    <label for="takeRate" style="font-size:14px; color:#eee;">區間取單率</label>
    <div style="display:flex; align-items:center; gap:3px;">
      <input type="number" id="takeRate" value=""
             style="width:70px; text-align:right; font-size:14px; background:#2a2a2a; color:#eee; border:1px solid #555; border-radius:6px; padding:4px 6px;">
      <span style="color:#ccc; font-size:14px;">%</span>
    </div>
  </div>

  <div id="generatedOrdersResult" style="margin-top:10px; font-size:15px; font-weight:bold; text-align:center; color:#eee;"></div>
  <div id="extraInfo" style="margin-top:5px; font-size:15px; font-weight:bold; text-align:center; color:#eee;"></div>

  <div style="text-align:center; margin-top:10px;">
    <button onclick="resetOrders()"
            style="background:#2a2a2a; color:#eee; border:1px solid #555; padding:6px 16px; border-radius:8px; font-size:14px;">
      重置
    </button>
  </div>
</div>

<script>
function calcOrders() {
  const completed = parseFloat(document.getElementById('completed').value);
  const takeRateInput = parseFloat(document.getElementById('takeRate').value);

  if (isNaN(completed) || isNaN(takeRateInput) || takeRateInput <= 0) {
    document.getElementById('generatedOrdersResult').innerText = '';
    document.getElementById('extraInfo').innerText = '';
    return;
  }

  const takeRate = takeRateInput / 100;
  const baseRate = 0.85;
  const generated = completed / takeRate;

  let extraText = '';
  if (takeRate >= baseRate) {
    const maxReject = (completed / baseRate) - generated;
    extraText = `還可以拒掉 ${maxReject.toFixed(2)} 單`;
  } else {
    const needComplete = (baseRate * generated - completed) / (1 - baseRate);
    extraText = `還需要完成 ${needComplete.toFixed(2)} 單`;
  }

  document.getElementById('generatedOrdersResult').innerText =
    `系統生成訂單數：${generated.toFixed(2)} 單`;
  document.getElementById('extraInfo').innerText = extraText;
}

function resetOrders() {
  document.getElementById('completed').value = "";
  document.getElementById('takeRate').value = "";
  document.getElementById('generatedOrdersResult').innerText = "";
  document.getElementById('extraInfo').innerText = "";
}

document.getElementById('completed').addEventListener('input', calcOrders);
document.getElementById('takeRate').addEventListener('input', calcOrders);

window.addEventListener("load", function() {
  resetValues();      // 重置倍率與公里數
  resetOrders();      // 重置取單率區
  calc();             // 確保公式區有更新
});
</script>

<div style="text-align:center; margin-top:30px; font-size:14px; color:#fc0303; line-height:1.8; border-top:1px solid #ccc; padding-top:10px;">
  ⚠️ 注意事項️ ⚠️ <br>
  ※ 舊制就會偷遠單公里數0.3~0.8公里不等，請自行再扣除※<br>
  ※ 以上僅供參考※<br>
  2025年10月20日 04:41 v1.2<br>
</div>
</body>
</html>
